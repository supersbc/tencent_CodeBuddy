version: "3.8"

# E-Log实验 - Apache IoTDB集群部署
# 3个数据节点 + 1个配置节点

services:
  # 配置节点
  iotdb-confignode:
    image: apache/iotdb:1.2.2
    container_name: iotdb-confignode
    hostname: iotdb-confignode
    networks:
      - iotdb-network
    ports:
      - "10710:10710"
      - "10720:10720"
    environment:
      - cn_internal_address=iotdb-confignode
      - cn_internal_port=10710
      - cn_consensus_port=10720
      - cn_target_config_node_list=iotdb-confignode:10710
      - schema_replication_factor=3
      - data_replication_factor=3
    volumes:
      - ./data/confignode:/iotdb/data
      - ./logs/confignode:/iotdb/logs
    command: ["bash", "-c", "start-confignode.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10710/"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # 数据节点1
  iotdb-datanode-1:
    image: apache/iotdb:1.2.2
    container_name: iotdb-datanode-1
    hostname: iotdb-datanode-1
    networks:
      - iotdb-network
    ports:
      - "6667:6667"
      - "10730:10730"
      - "9091:9091"  # Prometheus metrics
    environment:
      - dn_rpc_address=iotdb-datanode-1
      - dn_rpc_port=6667
      - dn_internal_address=iotdb-datanode-1
      - dn_internal_port=10730
      - dn_mpp_data_exchange_port=10740
      - dn_schema_region_consensus_port=10750
      - dn_data_region_consensus_port=10760
      - dn_seed_config_node=iotdb-confignode:10710
      - dn_target_config_node_list=iotdb-confignode:10710
      # E-Log特定配置
      - LOG_LEVEL=INFO
      - IOTDB_HEAP_SIZE=8G
    volumes:
      - ./data/datanode1:/iotdb/data
      - ./logs/datanode1:/iotdb/logs
    depends_on:
      - iotdb-confignode
    command: ["bash", "-c", "sleep 10 && start-datanode.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6667/"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # 数据节点2
  iotdb-datanode-2:
    image: apache/iotdb:1.2.2
    container_name: iotdb-datanode-2
    hostname: iotdb-datanode-2
    networks:
      - iotdb-network
    ports:
      - "6668:6667"
      - "10731:10730"
      - "9092:9091"
    environment:
      - dn_rpc_address=iotdb-datanode-2
      - dn_rpc_port=6667
      - dn_internal_address=iotdb-datanode-2
      - dn_internal_port=10730
      - dn_mpp_data_exchange_port=10740
      - dn_schema_region_consensus_port=10750
      - dn_data_region_consensus_port=10760
      - dn_seed_config_node=iotdb-confignode:10710
      - dn_target_config_node_list=iotdb-confignode:10710
      - LOG_LEVEL=INFO
      - IOTDB_HEAP_SIZE=8G
    volumes:
      - ./data/datanode2:/iotdb/data
      - ./logs/datanode2:/iotdb/logs
    depends_on:
      - iotdb-confignode
    command: ["bash", "-c", "sleep 15 && start-datanode.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6667/"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # 数据节点3
  iotdb-datanode-3:
    image: apache/iotdb:1.2.2
    container_name: iotdb-datanode-3
    hostname: iotdb-datanode-3
    networks:
      - iotdb-network
    ports:
      - "6669:6667"
      - "10732:10730"
      - "9093:9091"
    environment:
      - dn_rpc_address=iotdb-datanode-3
      - dn_rpc_port=6667
      - dn_internal_address=iotdb-datanode-3
      - dn_internal_port=10730
      - dn_mpp_data_exchange_port=10740
      - dn_schema_region_consensus_port=10750
      - dn_data_region_consensus_port=10760
      - dn_seed_config_node=iotdb-confignode:10710
      - dn_target_config_node_list=iotdb-confignode:10710
      - LOG_LEVEL=INFO
      - IOTDB_HEAP_SIZE=8G
    volumes:
      - ./data/datanode3:/iotdb/data
      - ./logs/datanode3:/iotdb/logs
    depends_on:
      - iotdb-confignode
    command: ["bash", "-c", "sleep 20 && start-datanode.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6667/"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # Prometheus监控（可选）
  prometheus:
    image: prom/prometheus:latest
    container_name: iotdb-prometheus
    networks:
      - iotdb-network
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./data/prometheus:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    restart: unless-stopped

  # Grafana可视化（可选）
  grafana:
    image: grafana/grafana:latest
    container_name: iotdb-grafana
    networks:
      - iotdb-network
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - ./data/grafana:/var/lib/grafana
    depends_on:
      - prometheus
    restart: unless-stopped

networks:
  iotdb-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  confignode-data:
  datanode1-data:
  datanode2-data:
  datanode3-data:
  prometheus-data:
  grafana-data:
